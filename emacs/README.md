

``` html
<!-- THIS FILE IS GENERATED BY emacs-init.org. -->

<!-- IT SHOULD NOT BE MODIFIED DIRECTLY. -->
```

This repository contains the files that make up my Emacs setup.

For the moment, that is my (literate) Emacs initialisation file and my
`yankpad` file.

# `emacs-init.org`

## Introduction

This is my `emacs` initialisation code, documented for my own
understanding in the future and for sharing with others.

I'm following [Musa Alhassy's](https://alhassy.github.io/init/) example
using an `org` file for this.

### Setting up `.emacs` to use this code

Create a symbolic link to this file in `~/.emacs.d/`, then add to the
bottom of `~/.emacs` these lines:

``` example
;; BEGIN my edits

;; I've set up an init file following Musa's guide:
;; https://alhassy.github.io/init/

;; Enable Emacs VC on symlinked files
(setq vc-follow-symlinks t)

;; Evaluate my init file.
(org-babel-load-file "~/.emacs.d/emacs-init.org")

;; Byte compile the file so that changes to emacs-init.org get picked up.
(byte-compile-file "~/.emacs")

;; END my edits
```

1.  Why set `vc-follow-symlinks` here?
    
    It's a setting I want anyway (it ensures Emacs's version control
    works correctly on the target file), but why set it in `.emacs`?
    
    Since `.emacs` uses a symlink to this version controlled file,
    having Emacs prompt me every time is annoying and slows my start up.

## `elisp` code

This section defines some functions/variables referred to below, that
either don't fit in a particular place below, or may be of general use.

### Theme change hook

[Apparently](https://www.reddit.com/r/emacs/comments/4v7tcj/), there is
no hook in Emacs for when a theme change occurs. This code snippet,
taken from the linked reddit post, defines one I can use.

``` commonlisp
(defvar after-load-theme-hook nil
  "Hook run after a color theme is loaded using `load-theme'.")
(defadvice load-theme (after run-after-load-theme-hook activate)
  "Run `after-load-theme-hook'."
  (run-hooks 'after-load-theme-hook))
```

### Cascading window setup

I set up my default desktop using a “cascading pattern”, moving from
larger windows in the upper right to smaller windows in the lower left.

This works best with 2 or 3 windows, but it can be used for more.

The process is:

  - If there are two or more files left to open:
      - Create a new window to the left.
      - Open the next file.
      - Move the focus to the left.
      - If there are two or more files left to open:
          - Create a new window below.
          - Open the next file.
          - Move focus down.
  - Else if there is one file left to open, open it.
  - Else, quit.

<!-- end list -->

``` commonlisp
(defun cascading-find-files (files)
  "Opens a set of files in a cascading series of windows,
created by splitting the current window.
The windows begin in the upper right, with the first file,
and move left and then down, each window being half the size
of the previous (as long as this is possible)."
  (while files ;; there's at least one file to open
    (find-file (car files))
    (setq files (cdr files))
    (when files ;; there are two or more files
      (split-window nil nil 'left)
      (other-window 1)
      (find-file (car files)) ;; open second file on the left
      (setq files  (cdr files))
      (when files ;; there are still more files, so split horizontally
        (split-window nil nil 'below)
        (other-window 1)))))
```

## Various packages

### Package repositories and `use-package`

``` commonlisp
(require 'package)
(setq package-archives
   '(("melpa" . "https://melpa.org/packages/")
     ("gnu" . "https://elpa.gnu.org/packages/")
     ("org" . "http://orgmode.org/elpa/")))
(package-initialize)
```

1.  Set the load path for manually downloaded packages
    
    (Currently I don't use manually downloaded packages)
    
    ``` commonlisp
    ;;(add-to-list 'load-path "~/Dropbox/Organisation/setup/emacs/downloaded-packages")
    ```

2.  Bootstrap `use-package`
    
    Using `use-package` allows me to easily migrate to new systems,
    because I don't have to `package-install` every package I use.
    
    Unless it's already installed, update the packages archives, then
    install the most recent version of “use-package”.
    
    ``` commonlisp
    (unless (package-installed-p 'use-package)
      (package-refresh-contents)
      (package-install 'use-package))
    
    (require 'use-package)
    ```
    
    I always want to download packages that aren't installed.
    
    ``` commonlisp
    (setq use-package-always-ensure t)
    ```

### `eshell`

``` commonlisp
(use-package eshell)
```

Jeremias Queiroz posted a “fancy eshell prompt” setup on
[Reddit](https://www.reddit.com/r/emacs/comments/6f0rkz/my_fancy_eshell_prompt/),
from which I derived this setup, but I've modified it to use builtin
face colours to improve portability across themes.

``` commonlisp
(setq eshell-prompt-function
(lambda ()
  (let ((white  `(face-attribute 'default :foreground))
        (green  `(face-attribute 'success :foreground))
        (red    `(face-attribute 'error   :foreground))
        (blue   `(face-attribute 'link    :foreground))
        (yellow `(face-attribute 'warning :foreground)))
  (concat
  (propertize "┌─["                 'face green)
  (propertize (user-login-name)     'face red)
  (propertize "@"                   'face green)
  (propertize (system-name)         'face blue)
  (propertize "]──["                'face green)
  (propertize (format-time-string "%H:%M" (current-time)) 'face yellow)
  (propertize "]──["                'face green)
  (propertize (concat (eshell/pwd)) 'face white)
  (propertize "]\n"                 'face green)
  (propertize "└─>"                 'face green)
  (propertize (if (= (user-uid) 0) " # " " $ ") 'face green))
)))
```

### `agda` mode

We need Emacs to locate Agda mode. This command is put in `.emacs`

``` commonlisp
(load-file (let ((coding-system-for-read 'utf-8))
                (shell-command-to-string "agda-mode locate")))
```

These packages are installed when setting up Agda, so I simply `require`
them.

``` commonlisp
(require 'agda-input)
(require 'agda2-highlight)
```

1.  Command line arguments
    
    Dr. Wolfram Kahl has recommended customising the following settings.
    (note that my machine is a virtual machine running on a Chromebook
    with a little less than `5G` available to it).
    
    ``` commonlisp
    (setq agda2-program-args (quote ("+RTS" "-M3G" "-H3G" "-A128M" "-RTS")))
    ```
    
    These arguments specify
    
    |                |                                                        |
    | -------------- | ------------------------------------------------------ |
    | `+RTS`, `-RTS` | Flags between these are arguments to the `ghc` runtime |
    | `-M[size]`     | Maximum heap size                                      |
    | `-H[size]`     | Suggested heap size                                    |
    | `-A[size]`     | Allocation area size used by the garbage collector     |
    

    Full documentation for the `ghc` runtime argumentscan be found
    [here](https://downloads.haskell.org/~ghc/7.8.4/docs/html/users_guide/runtime-control.html).
    
    Additional arguments that may be useful include
    
    |            |                                                                |
    | ---------- | -------------------------------------------------------------- |
    | `-S[file]` | Produces information about “each and every garbage collection” |
    |            | \- Outputs to `stderr` by default                              |
    

2.  Alternative problem highlighting
    
    I find the background coloring used by Agda for incomplete pattern
    matching, redundant clauses and clauses which do not hold
    definitionally hard to read in general, and usually unreadable with
    different themes.
    
    So I use set other indicators instead.
    
    ``` commonlisp
    (defun my-agda-highlighting ()
      "Set face attributes to replace Agda highlighting,
      which I find hard to read in many situations."
      (set-face-attribute
        'agda2-highlight-coverage-problem-face
        nil ;; all frames
        :background nil
        :underline "dark red"
      )
      (set-face-attribute
        'agda2-highlight-deadcode-face
        nil ;; all frames
        :background nil
        :strike-through t
      )
      (set-face-attribute
        'agda2-highlight-catchall-clause-face
        nil ;; all frames
        :background nil
        :slant 'italic
      )
    )
    
    (add-hook 'agda2-mode-hook 'my-agda-highlighting)
    ```

3.  Add unicode characters to Agda's translations
    
    1.  Punctuation and parentheses
        
        ``` commonlisp
        (add-to-list 'agda-input-user-translations '(";;" "﹔"))
        (add-to-list 'agda-input-user-translations '(";;" "⨾"))
        (add-to-list 'agda-input-user-translations '("|" "❙"))
        (add-to-list 'agda-input-user-translations '("st" "•"))
        (add-to-list 'agda-input-user-translations '("{" "｛"))
        (add-to-list 'agda-input-user-translations '("}" "｝"))
        (add-to-list 'agda-input-user-translations '("{" "⁅"))
        (add-to-list 'agda-input-user-translations '("}" "⁆"))
        ```
    
    2.  Correct mistakes on subscripts/superscripts
        
        I often accidentally hold the shift key for too long when
        entering subscripts and superscripts; these translations account
        for that.
        
        ``` commonlisp
        (add-to-list 'agda-input-user-translations '("^!" "¹"))
        (add-to-list 'agda-input-user-translations '("^@" "²"))
        (add-to-list 'agda-input-user-translations '("^#" "³"))
        (add-to-list 'agda-input-user-translations '("^$" "⁴"))
        (add-to-list 'agda-input-user-translations '("^%" "⁵"))
        (add-to-list 'agda-input-user-translations '("^^" "⁶"))
        (add-to-list 'agda-input-user-translations '("^&" "⁷"))
        (add-to-list 'agda-input-user-translations '("^*" "⁸"))
        (add-to-list 'agda-input-user-translations '("^(" "⁹"))
        (add-to-list 'agda-input-user-translations '("^)" "⁰"))
        (add-to-list 'agda-input-user-translations '("_!" "₁"))
        (add-to-list 'agda-input-user-translations '("_@" "₂"))
        (add-to-list 'agda-input-user-translations '("_#" "₃"))
        (add-to-list 'agda-input-user-translations '("_$" "₄"))
        (add-to-list 'agda-input-user-translations '("_%" "₅"))
        (add-to-list 'agda-input-user-translations '("_^" "₆"))
        (add-to-list 'agda-input-user-translations '("_&" "₇"))
        (add-to-list 'agda-input-user-translations '("_*" "₈"))
        (add-to-list 'agda-input-user-translations '("_(" "₉"))
        (add-to-list 'agda-input-user-translations '("_)" "₀"))
        ```
    
    3.  Activate the new additions
        
        ``` commonlisp
        (agda-input-setup)
        ```

4.  Activate Agda input mode in `text` and `prog` modes
    
    ``` commonlisp
    (add-hook 'text-mode-hook
           (lambda () (set-input-method "Agda")))
    (add-hook 'prog-mode-hook
           (lambda () (set-input-method "Agda")))
    ```

### Other programming languages

1.  The Mozart Programming System for `Oz`
    
    The Mozart Programming System “provides a powerful environment for
    the development of software systems, called the \`\`Oz Programming
    interface" (OPI)”. See the [github.io](https://mozart.github.io/)
    page. Specifically, [this
    page](https://mozart.github.io/mozart-v1/doc-1.4.0/opi/node2.html)
    which discusses how to invoke the API (though at time of writing,
    the documentation is for Mozart `v1`, not the current Mozart `v2`).
    
    Upon installation, the Mozart programming system provides a shell
    command, `oz`, (and usually also a application shortcut) for
    launching an Emacs process with the Mozart sub-process.
    
    Since I'm presumably running Emacs already, this is not how I wish
    to invoke the OPI. Instead, I check for an Oz installation under
    `usr/bin/oz`, and set up invokation of the OPI from within Emacs.
    
    (Note: I install Mozart from pre-built binaries, which are
    distributed [on their Github
    page](https://github.com/mozart/mozart2/releases). Depending upon
    how you install Mozart, you may need to modify the directories below
    (notably, my directories differ from those mentioned on the
    `github.io` page).
    
    For Mozart to work, we need to set the `OZHOME` environment
    variable.
    
    ``` commonlisp
    (setq my-oz-home "/usr")
    
    (when (file-directory-p my-oz-home)
      (setenv "OZHOME" my-oz-home)
    )
    ```
    
    Note this must be done before loading the `elisp`, because the
    `elisp` attempts to start a `oz` server. If it fails to do so, we
    will receive errors such as “Searching for program: No such file or
    directory, ./bin/ozengine”.
    
    Of course, it's a good idea to check that Oz is installed on the
    system, so set the location of the Mozart `elisp` code, check that
    that location exists, and then load it and set up auto loads.
    
    ``` commonlisp
    (setq my-mozart-elisp "/usr/share/mozart/elisp")
    
    (when (file-directory-p my-mozart-elisp)
      (add-to-list 'load-path my-mozart-elisp)
      (load "mozart")
      (add-to-list 'auto-mode-alist '("\\.oz\\'" . oz-mode))
      (add-to-list 'auto-mode-alist '("\\.ozg\\'" . oz-gump-mode))
      (autoload 'run-oz "oz" "" t)
      (autoload 'oz-mode "oz" "" t)
      (autoload 'oz-gump-mode "oz" "" t)
      (autoload 'oz-new-buffer "oz" "" t)
    )
    ```
    
    `oz-mode` annoyingly remaps `C-x SPC`, so we must undo that.
    
    ``` commonlisp
    (eval-after-load "oz-mode"
      '(progn
        (define-key oz-mode-map (kbd "C-x SPC") 'rectangle-mark-mode)
    ))
    ```
    
    Below, in my Org mode setup under [1.3.5.5](#Evaluating%20code), I
    set up literate Oz (it only takes `(require 'ob-oz)`).

### Org mode

I use Org for almost everything, and utilise many of the extras included
in `org-plus-contrib`.

``` commonlisp
(use-package org
  :ensure org-plus-contrib
  :config
  (require 'ox-extra)
)
```

1.  Capture
    
    I'm beginning to use `org-capture` to enable me to log ideas/TODO
    items from anywhere in Emacs in my log file.
    
    ``` commonlisp
    (setq org-default-notes-file "~/Dropbox/Organisation/log/log.org")
    ```
    
    Currently I just use the default capture template, and manually
    organise ideas later. Once I use this system for a while, I should
    ideally set up other templates to automate some of this.

2.  Agenda
    
    My log file is my agenda.
    
    ``` commonlisp
    (setq org-agenda-files '("~/Dropbox/Organisation/log/log.org"))
    ```

3.  Speed keys
    
    Speed keys are single keystrokes which execute commands in an `org`
    file when the cursor is at the start of a headline.
    
    ``` commonlisp
    (setq org-use-speed-commands t)
    ```
    
    To see the commands available, execute
    
    ``` example
    (org-speed-command-help)
    ```

4.  Exporting
    
    1.  Allow for ignoring headlines and/or subtrees
        
        Use the `:ignore:` tag on headlines to omit the headline when
        exporting, but keep its contents.
        
        ``` commonlisp
        (ox-extras-activate '(ignore-headlines))
        ```
        
        Alternatively, use the `:noexport:` tag to omit the headline
        *and* its contents.
        
        ``` commonlisp
        ;;;; noexport is in the list by default
        ;; (add-to-list 'org-export-exclude-tags "noexport")
        ```
    
    2.  Source code block indentation and colouring
        
        I want to preserve my indentation for source code during export.
        
        ``` commonlisp
        (setq org-src-preserve-indentation t)
        ```
        
        The `htmlize` package preserves source code colouring on export
        to html. (And presumably does a lot more I am not fully aware
        of).
        
        ``` commonlisp
        (use-package htmlize)
        ```
    
    3.  Export in the background
        
        Using `latex-mk`, the export process takes a bit of time. Tying
        up emacs during that time is annoying, so set the export to
        happen in the background. This setting can be modified locally
        in the export dialog frame if desired.
        
        ``` commonlisp
        (setq org-export-in-background t)
        ```
        
        This works by spawning a new Emacs session. That session uses
        this init file, so we must be careful that this file works for
        daemon (headless) Emacs processes. See
        [1.6.7.2](#Opening%20the%20initial%20buffers) for how to deal
        with problematic portions.
        
        Another possible solution would be to modify
        `org-export-async-init-file`, but that would require creation of
        a new init file. To use this approach, I would have to repeat
        large portions of this file. If this approach is ever desirable,
        this [answer on
        StackExchange](https://superuser.com/a/898717/1032497) describes
        how to create such a file using Lisp code.
    
    4.  LaTeX specific
        
        1.  Default LaTeX compiler
            
            I use a lot of unicode, and I find `xelatex` and `lualatex`
            handle that more easily than `pdflatex`.
            
            From my experience so far, they seem pretty interchangable
            for my purposes, so the decision of which to use is
            arbitrary.
            
            Based on [this discussion on Stack
            Exchange](https://tex.stackexchange.com/questions/36/differences-between-luatex-context-and-xetex),
            LuaTeX seems the more “up and coming” engine, so I'm using
            it at least until something breaks.
            
            ``` commonlisp
            (setq org-latex-compiler "lualatex")
            ```
        
        2.  LaTeX compilation process
            
            I use `latexmk` to automatically run as many passes as
            needed to resolve references, etc.
            
            ``` commonlisp
            (setq org-latex-pdf-process
                  '("latexmk -%latex -f %f"))
            ```
            
            The flags/format specifiers are
            
            |          |                                                                  |
            | -------- | ---------------------------------------------------------------- |
            | `%latex` | stands in for the latex compiler (defaults to the setting above) |
            | `-f`     | force continued processing past errors                           |
            | `%f`     | stands in for the (relative) filename                            |
            

            Other flags/format specifiers I may wish to add later
            include
            
            |                 |                           |
            | --------------- | ------------------------- |
            | `-shell-escape` | necessary to use `minted` |
            

        3.  Custom document classes
            
            I want a `report` class that begins with `chapter`'s, rather
            than `part`'s.
            
            ``` commonlisp
            (add-to-list
              'org-latex-classes
                '("report-noparts"
                  "\\documentclass{report}"
                  ("\\chapter{%s}" . "\\chapter*{%s}")
                  ("\\section{%s}" . "\\section*{%s}")
                  ("\\subsection{%s}" . "\\subsection*{%s}")
                  ("\\subsubsection{%s}" . "\\subsubsection*{%s}")
                  ("\\paragraph{%s}" . "\\paragraph*{%s}")
                  ("\\subparagraph{%s}" . "\\subparagraph*{%s}")))
            ```
            
            Sometimes, for creating slides, `beamer` is useful. (Though
            I try to avoid it now; it feels low level to me).
            
            ``` commonlisp
            (add-to-list
              'org-latex-classes
                '("beamer"
                  "\\documentclass[presentation]{beamer}"
                  ("\\section{%s}" . "\\section*{%s}")
                  ("\\subsection{%s}" . "\\subsection*{%s}")
                  ("\\subsubsection{%s}" . "\\subsubsection*{%s}")))
            ```
        
        4.  Source code colouring in LaTeX exports
            
            We can use `minted` for source code colouring on export to
            LaTeX.
            
            Currently this breaks things with my literate Agda process,
            a problem I should resolve. For the moment, if I want to use
            `minted`, I can do so on a file-by-file basis.
            
            ⟪ `pygments` (also called `python-pygments`) must be
            installed on the system for this to work. ⟫
            
            ``` commonlisp
            ;;(setq org-latex-listings 'minted
            ;;      org-latex-packages-alist '(("" "minted")))
            ```
    
    5.  `org-reveal`
        
        I make use of `org-reveal` to create `reveal.js` slide decks.
        This is way easier than dealing with `beamer` in LaTeX, and
        results in much more attractive and better organised slides.
        
        ``` commonlisp
        (use-package ox-reveal)
        
        (setq org-reveal-root "file:///home/markparmstrong/Dropbox/Organisation/downloaded/reveal.js-3.8.0/")
        ```
        
        1.  Slide appearance
            
            1.  Theme
                
                `reveal.js` comes with many themes; `black` is the
                current default at time of writing this. I set it just
                to be sure it stays consistent.
                
                ``` commonlisp
                (setq org-reveal-theme "black")
                ```
                
                At the time of writing, the included themes are
                
                  - `black`: Black background, white text, blue links
                  - `white`: White background, black text, blue links
                  - `league`: Gray background, white text, blue links
                  - `beige`: Beige background, dark text, brown links
                  - `sky`: Blue background, thin dark text, blue links
                  - `night`: Black background, thick white text, orange
                    links
                  - `serif`: Cappuccino background, gray text, brown
                    links
                  - `simple`: White background, black text, blue links
                  - `solarized`: Cream-colored background, dark green
                    text, blue links
                
                (list from the [`reveal.js`
                github](https://github.com/hakimel/reveal.js/#theming)).
            
            2.  Title page
                
                The default title slide includes title and date, with
                the formatting
                
                ``` html
                <h1 class="title">%t</h1>
                <p class="date">Created: %d/p>
                ```
                
                where `%t` stands for the document title and `%d` stands
                for the date. I override this setting
                
                ``` commonlisp
                (setq org-reveal-title-slide
                  "<h2 class=\"title\">%t</h2>
                   <h3>%s</h3>
                   <h4>%a</h4>
                   <h5>%d</h5>")
                ```
            
            3.  Default slide height, width, margin and scaling
                
                These settings are depricated; I need to remove this.
                
                ``` commonlisp
                ;;(setq org-reveal-height 5000)
                ;;(setq org-reveal-width 1200)
                ;;(setq org-reveal-margin "0.1")
                ;;(setq org-reveal-min-scale "0.05")
                ;;(setq org-reveal-max-scale "5")
                ```
            
            4.  Extra CSS
                
                I should set this up.
                
                ``` commonlisp
                (setq org-reveal-extra-css "")
                ```
    
    6.  `ox-pandoc`
        
        `ox-pandoc` is “another exporter that translates Org-mode file
        to various other formats via Pandoc”.
        
        I don't make much use of it, but it more flexible, and so has
        lots of options which make be useful in the future.
        
        ``` commonlisp
        (use-package ox-pandoc)
        ```
    
    7.  `ox-tufte`
        
        (This section is deprecated; I now use
        [Read-the-Org](https://github.com/fniessen/org-html-themes/blob/master/README.org)
        as the theme for my websites).
        
        At one point I considered using [Tufte
        CSS](https://github.com/edwardtufte/tufte-css) for websites;
        `ox-tufte` exports is a package to export `html` which is nicely
        compatible with this style sheet. See the Github readme
        [here](https://github.com/dakrone/ox-tufte).
        
        ``` commonlisp
        ;(use-package ox-tufte)
        ```
        
        I found `ox-tufte` mentioned in a [Reddit
        thread](https://www.reddit.com/r/emacs/comments/6r32q4)
        regarding CSS for Org html export.

5.  Evaluating code
    
    By default, Emacs will query whether we *actually* want to execute
    code when we evaluate a code block. Also, it seems to just *not*
    execute code marked for execution during export in an `org` file.
    So, I remove the safety.
    
    ``` commonlisp
    (setq org-confirm-babel-evaluate nil)
    ```
    
    Loading the following languages with `require` allows code blocks in
    them to be evaluated.
    
    By default only emacs lisp can be evaluated.
    
    Documentation [here](https://orgmode.org/manual/Languages.html).
    
    ``` commonlisp
    (require 'ob-shell)
    (require 'ob-haskell)
    (require 'ob-latex)
    (require 'ob-oz)
    (require 'ob-C)
    (require 'ob-ruby)
    ```
    
    For shell code, we need to initialise via this function. See
    [here](https://emacs.stackexchange.com/questions/37692/how-to-fix-symbols-function-definition-is-void-org-babel-get-header).
    
    ``` commonlisp
    (org-babel-shell-initialize)
    ```

6.  Cosmetics
    
    1.  Indent text based on heading by default
        
        ``` commonlisp
        (add-hook 'org-mode-hook 'org-indent-mode)
        ```
    
    2.  Hide emphasis markers by default
        
        ``` commonlisp
        (setq org-hide-emphasis-markers t)
        ```
    
    3.  Highlight math mode blocks
        
        ``` commonlisp
        (setq org-highlight-latex-and-related '(latex))
        ```
    
    4.  Replace the ellipsis `...`
        
        By default, folded portions of the document are presented by an
        ellipsis, `...`. Let's replace that.
        
        ``` commonlisp
        (setq org-ellipsis " ⤵")
        ```
        
        But I find this is not particularly visible with my theme; it
        gets set to a very faint colour. So, I customise the
        `org-ellipsis` face so that it has the same colour as the rest
        of the headline. It has to be set after every theme change, or
        the setting will be overwritten (probably the themes I use set
        it specifically?).
        
        ``` commonlisp
        (add-hook 'after-load-theme-hook
          (lambda ()
            (set-face-attribute
              'org-ellipsis
              nil ;; all frames
              :foreground 'unspecified
            )
          )
        )
        ```
    
    5.  Tables
        
        I prefer to work with wordwrap on, so tables can be quite
        problematic.
        
        The solution is to set column widths so that we can collapse
        tables. In recent Org mode versions, we need to enable
        collapsing.
        
        ``` commonlisp
        (setq org-startup-align-all-table t)
        ```
    
    6.  Inline images
        
        We can configure Org to automatically inline linked images when
        opening documents.
        
        ``` commonlisp
        (setq org-startup-with-inline-images t)
        ```
        
        ``` commonlisp
        (setq org-image-actual-width nil)
        ```

7.  Other
    
    1.  Allow alphabetical lists
        
        ``` commonlisp
        (setq org-list-allow-alphabetical t)
        ```
    
    2.  Reveal hidden elements if they are edited
        
        To avoid, for instance, accidentally editing folded portions of
        the document.
        
        ``` commonlisp
        (setq org-catch-invisible-edits 'show)
        ```

### `pdf-tools`

``` commonlisp
(use-package pdf-tools)
```

Need to “install” it each time emacs starts

``` commonlisp
(pdf-tools-install)
```

### `yankpad` and `yasnippets`

I use `yasnippets` for text expansion, and `yankpad` to organise my
snippets.

For inserting snippets, we require string manipulation functions from
the `subr-x` package (built-in).

``` commonlisp
(require 'subr-x)
```

``` commonlisp
(use-package yasnippet)
(yas-global-mode t)

(use-package yankpad)
(setq yankpad-file "~/Dropbox/Organisation/setup/emacs/yankpad.org")
```

`yas-wrap-around-region` controls what is inserted for a snippet's `$0`
field. A non-nil, non-character setting has it insert the current
region's contents (i.e. if we highlight a region and invoke a snippet,
the region will be wrapped).

``` commonlisp
(setq yas-wrap-around-region t)
```

`yas-indent-line` controls how inserted snippets are inserted. `fixed`
indicates the snippet should be indented to the column at point. `auto`
instead causes each line to be indented using
`indent-according-to-mode`. I set it to fixed because this is usually
what I want; I know best, not the mode.

``` commonlisp
(setq yas-indent-line 'fixed)
```

1.  Don't add a final newline when editing snippet files
    
    `yasnippets` will insert the final newline when expanding a snippet,
    so snippet files generally shouldn't include a final newline.
    
    ``` commonlisp
    (add-hook 'snippet-mode-hook (setq require-final-newline nil))
    ```

### `dired`

I use `dired` for browsing directories; it's simple, and with the right
configuration, very easy to use.

1.  Display preferences
    
    `dired` makes use of switches for `ls`.
    
    I like the following switches:
    
    |                             |                                                              |
    | --------------------------- | ------------------------------------------------------------ |
    | `--group-directories-first` | group directories before files                               |
    | `-a`                        | do not ignore entries starting with .                        |
    | `-B`                        | do not list implied entries ending with \~                   |
    | `-g`                        | long listing format, but do not list owner                   |
    | `-G`                        | in a long listing, don't print group names                   |
    | `-h`                        | print human readable size                                    |
    | `-L`                        | show information for *references* rather than symbolic links |
    

    ``` commonlisp
    (setq dired-listing-switches "--group-directories-first -aBgGhL")
    ```

2.  Use only one buffer for `dired`
    
    I use `dired-single` to avoid `dired` opening a new buffer for every
    directory visited.
    
    ``` commonlisp
    (use-package dired-single)
    ```
    
    I use a “magic” buffer with the name `*Dired*`, to avoid the single
    `dired` buffer being named after whatever directory I first visit.
    
    ``` commonlisp
    (setq dired-single-use-magic-buffer t)
    (setq dired-single-magic-buffer-name "*Dired*")
    ```
    
    The below code, which rebinds keys to use `dired-single` rather than
    `dired`, is taken directly from the `dired-single` [GitHub
    readme](https://github.com/crocket/dired-single).
    
    ``` commonlisp
    (defun my-dired-init ()
      "Bunch of stuff to run for dired, either immediately or when it's
       loaded."
      ;; <add other stuff here>
      (define-key dired-mode-map [return] 'dired-single-buffer)
      (define-key dired-mode-map [mouse-1] 'dired-single-buffer-mouse)
      (define-key dired-mode-map "." 'dired-single-up-directory)
    )
    
    ;; if dired's already loaded, then the keymap will be bound
    (if (boundp 'dired-mode-map)
            ;; we're good to go; just add our bindings
            (my-dired-init)
      ;; it's not loaded yet, so add our bindings to the load-hook
      (add-hook 'dired-load-hook 'my-dired-init))
    ```

### `magit`

``` commonlisp
(use-package magit)
```

### Email: `mu4e` (with `mbsync`)

Using Emacs as an email client provides us with powerful text editing
while composing email.

``` commonlisp
(add-to-list 'load-path "/usr/share/emacs/site-lisp/mu4e")
(require 'mu4e)
```

``` commonlisp
(setq
  mu4e-maildir       "/mnt/chromeos/removable/SD Card/Crostini/.mail"
  mu4e-sent-folder   "/sent"
  mu4e-drafts-folder "/drafts"
  mu4e-trash-folder  "/trash"
  mu4e-refile-folder "/archive")
```

### `winner` for saving and restoring window layouts

``` commonlisp
(winner-mode 1)
```

### `exwm`

I've considered using the Emacs window manager, `exwm`, but on my
Chromebook, I can't replace the window manager. So it remains simply a
possibility for the future.

``` commonlisp
;(use-package exwm)
;(require 'exwm-config)
;(exwm-config-default)
```

## Key bindings

I make use of `hydra` for keybindings (or groups of keybindings) which
will be executed several times in a row.

I also make use of `general` to organise other keybindings.

``` commonlisp
(use-package general)
```

### `general` definers

You can use `general-define-key` directly to define shortcuts, ideally
using the keyword argument `:prefix` to avoid repeating prefixes, but if
you are (even only possibly) using a prefix several times, it's better
to create a custom function to use instead of `general-define-key`.

Setting `:keymaps` to `'override` ensures that no package will override
my shortcuts.

For the moment, I'm experimenting with using `s`-key (“super”-key)
combinations as prefixes. I have my caps lock bound to super (on my
Chromebook's internal keyboard it's bound to that by default), and I
think if I restrict the combination keys to those on the left side of
the keyboard, I can avoid “Emacs pinky”.

So far I have three categories of shortcuts:

  - My main shortcuts, those that don't fall into another category.
  - Shortcuts to navigate around the current buffer.
  - Shortcuts to open a `dired` buffer for a certain folder.

<!-- end list -->

``` commonlisp
(general-create-definer general-main-define-key
  :prefix "s-a"
  :keymaps 'override)

(general-create-definer general-window-define-key
  :prefix "s-w"
  :keymaps 'override)

(general-create-definer general-dired-define-key
  :prefix "s-d"
  :keymaps 'override)
```

### Invoke processes

These bindings invoke various processes, such as `dired` or `eshell`.
They either have their own definer above, or are bound to a single key
combo.

1.  `yankpad`
    
    I use a non-prefixed shortcut for snippet expansion, since I do it
    all the time. (at least until yankpad has smart tab expansion).
    
    ``` commonlisp
    (general-define-key
      "s-f" 'yankpad-expand)
    ```
    
    Alternatively, `y m` invokes `yankpad-map`, which brings up a keymap
    of the last tags of snippets.
    
    ``` commonlisp
    (general-main-define-key
      "y m" 'yankpad-map)
    ```
    
    Changes to the yankpad file require `yankpad-reload` to be run to
    re-cache the snippets. For the moment, it seems like there is
    separate caching for each buffer, meaning this command has to be run
    in every buffer where I want changes to be picked up. So, I have a
    shortcut key.
    
    ``` commonlisp
    (general-main-define-key
      "y r" 'yankpad-reload)
    ```

2.  `dired`
    
    I use shortcuts to jump to frequently used directories in `dired`
    (from any buffer, not just while in `dired`).
    
    As seen in `Cosmetics`, I use `dired-single` in order to only have
    one `dired` buffer at a time. In case this changes, I define another
    local variable to store the command to invoke `dired` with.
    
    ``` commonlisp
    (defun my-dired-invocation (directory)
      "My custom dired invocation.
       It will use my special “magic buffer” for browsing."
      (dired-single-magic-buffer directory))
    ```
    
    ``` commonlisp
    (general-dired-define-key
      "c" '((lambda () (interactive)
              (my-dired-invocation default-directory))
            :which-key "Current")
      "h" '((lambda () (interactive)
              (my-dired-invocation "~"))
            :which-key "Home")
      "d" '((lambda () (interactive)
              (my-dired-invocation "~/Dropbox/"))
            :which-key "Dropbox")
      "o" '((lambda () (interactive)
              (my-dired-invocation "~/Dropbox/Organisation/"))
            :which-key "Organisation")
      "r" '((lambda () (interactive)
              (my-dired-invocation "~/Dropbox/Organisation/reading/"))
            :which-key "Organisation")
      "p" '((lambda () (interactive)
              (my-dired-invocation "~/Dropbox/Projects/"))
            :which-key "Projects")
      "m" '((lambda () (interactive)
              (my-dired-invocation "~/Dropbox/McMaster/"))
            :which-key "McMaster")
      "a" '((lambda () (interactive)
              (my-dired-invocation "~/Dropbox/McMaster/Agda/"))
            :which-key "Agda")
      "t" '((lambda () (interactive)
              (my-dired-invocation "~/Dropbox/McMaster/Agda/thesis/"))
            :which-key "Thesis")
      "3" '(:ignore t :which-key "3rd year classes")
      "3m" '((lambda () (interactive)
              (my-dired-invocation "~/Dropbox/McMaster/3mi3/"))
            :which-key "3mi3")
      "3e" '((lambda () (interactive)
              (my-dired-invocation "~/Dropbox/McMaster/3ea3/"))
            :which-key "3ea3")
    )
    ```

3.  `eshell`
    
    ``` commonlisp
    (general-define-key
      "s-s" 'eshell)
    ```

4.  `magit`
    
    I often find myself using `s-g` in place of `c-g` when using my
    keybindings (which begin with super). So, I avoid using it for
    starting `magit`.
    
    ``` commonlisp
    (general-define-key
      "s-m" 'magit-status
    )
    ```

5.  `recentf`
    
    ``` commonlisp
    (general-define-key
      "s-r" 'recentf-open-files
    )
    ```

### Buffer navigation and management, window and theme management

Somewhat sinfully, here I group shortcuts relating to the buffer, the
window(s) and the cosmetics of the frame, into one (conceptual)
category: “window”, prefix `w`.

``` commonlisp
(general-window-define-key
  "r" '((lambda () (interactive) (revert-buffer () t ()))
        :which-key "Revert buffer")
  "u" '((lambda () (interactive) (undo-tree-visualize))
        :which-key "Undo tree")

  "s"   '(:ignore t
          :which-key "Session management")
  "s c" '((lambda () (interactive) (desktop-clear))
          :which-key "Session clear")

  "b"   '(:ignore t
          :which-key "Buffer navigation")
  "b t" '((lambda () (interactive) (beginning-of-buffer))
          :which-key "Top of buffer")
  "b b" '((lambda () (interactive) (end-of-buffer))
          :which-key "Bottom of buffer")

  "t"   '(:ignore t
          :which-key "Theme management")
  "t t" '((lambda () (interactive) (toggle-my-themes))
          :which-key "Toggle theme")
  "t c" '((lambda () (interactive) (disable-all-custom-themes))
          :which-key "Clear theme")

  "<right>" '((lambda () (interactive) (windmove-right))
              :which-key "Move focus right")
  "<left>"  '((lambda () (interactive) (windmove-left))
              :which-key "Move focus left")
  "<up>"    '((lambda () (interactive) (windmove-up))
              :which-key "Move focus up")
  "<down>"  '((lambda () (interactive) (windmove-down))
              :which-key "Move focus down")

  "\\" '((lambda () (interactive)
                 (cascading-find-files my-initial-files))
         :which-key "My initial windows")
  "["  '(winner-undo
         :which-key "Undo layout change")
  "]"  '(winner-redo
         :which-key "Redo layout change")

  "-"     '((lambda () (interactive) (shrink-window 5))
            :which-key "Shrink window")
  "="     '((lambda () (interactive) (enlarge-window 5))
            :which-key "Enlarge window")
  "_"     '((lambda () (interactive) (shrink-window 999))
            :which-key "“Minimise” window")
  "+"     '((lambda () (interactive) (enlarge-window 999))
            :which-key "“Maximise”  window")
)
```

### Other

These are cosmetics relating to lines in the current buffer.

``` commonlisp
(general-main-define-key
  "l"     '(:ignore t
            :which-key "Line cosmetics")
  "l n"   '(:ignore t
            :which-key "Line numbers")
  "l n y" '((lambda () (interactive) (display-line-numbers-mode 1))
            :which-key "Line numbers - yes")
  "l n n" '((lambda () (interactive) (display-line-numbers-mode 0))
            :which-key "Line numbers - no")
  "l w"   '(:ignore t
            :which-key "Line wrap")
  "l w y" '((lambda () (interactive) (visual-line-mode 1))
            :which-key "Line wrap - yes")
  "l w n" '((lambda () (interactive) (visual-line-mode 0))
            :which-key "Line wrap - no")
  "l l"   '(:ignore t
            :which-key "Long line highlighting")
)
```

``` commonlisp
(general-main-define-key
  "j" 'dad-joke
)
```

## Navigation

### Jump between windows using `windmove`

The package `windmove` lets us jump between windows in a frame.

``` commonlisp
(use-package windmove)
```

For the uninitiated, a *window* in Emacs is not the same as the OS
window. Each OS window is a *frame*, and each pane within a frame is
called a *window*. (Emacs predates modern terminology).

`windmove` lets us move between windows with the arrow keys while
holding a key; by default, the key is `shift`. That conflicts with `org`
though, so we could use `windmove-default-keybindings` to change it.

Unfortunately, on my system, all the other possibilities seem to be
taken with system shortcuts (which I cannot modify in ChromeOS), or
otherwise taken in Emacs.

So instead I've defined shortcuts using `general` above.

### Change scrolling (shortcut) behaviour

I find the scrolling shortcuts `scroll-up-command` (`C-v`) and
`scroll-down-command` (`M-v`) “too aggressive”. They scroll the screen
by nearly the whole window height, by default leaving visible only 2
lines which were visible.

I find adjusting this upwards makes it easier to follow along with a
document as scrolling.

``` commonlisp
(setq next-screen-context-lines 16)
```

Keep in mind `recenter` (`C-l`) when scrolling this way to recenter the
screen on the current line.

## Cosmetics

### Themes

I use the `doom-nord` themes, and toggle between the non-`light` and
`light` variants.

``` commonlisp
(use-package doom-themes)

(load-theme 'doom-nord t)

(setq my-dark-theme 'doom-nord)
(setq my-light-theme 'doom-nord-light)

(defun disable-all-custom-themes ()
  "Disable all custom themes.
   Returns the previous highest precendence theme
   (nil if no themes were previously enabled).

   Implementation:
     Gets the highest precedence applied theme as the first element
     of custom-enabled-themes.

     Then iteratively disables all the themes in custom-enabled-themes.
  "
  (let ((most-recent-theme (car custom-enabled-themes)))
    (while (car custom-enabled-themes)
      (disable-theme (car custom-enabled-themes)))
    most-recent-theme
  )
)

(defun toggle-my-themes ()
  "Disable all custom, then try to toggle the themes
   my-dark-theme and my-light-theme, in that if one was
   the last applied theme, the other will be applied.

   If neither was the last applied theme, my-dark-theme
   will be applied as a default.
  "

  (let ((most-recent-theme (disable-all-custom-themes)))
    (if (eq most-recent-theme my-dark-theme)
        (load-theme my-light-theme)
        (load-theme my-dark-theme)
    )
  )
)

(eq (car custom-enabled-themes) my-dark-theme)
(disable-all-custom-themes)
(toggle-my-themes)
```

Make it “play nice” with `org`

``` commonlisp
(doom-themes-org-config)
```

### Displaying/removing information and interface elements

There are several tweaks I like to display important information and
hide unimportant information or interfact elements.

1.  Remove unnecessary interface elements
    
    Emacs usually shows a splash screen on startup, which doesn't
    interest me.
    
    ``` commonlisp
    (setq inhibit-splash-screen t)
    ```
    
    I don't use the tool bar (icons below the menu bar). (This setting
    must be `-1`, not `()`).
    
    ``` commonlisp
    (tool-bar-mode -1)
    ```
    
    I also don't use the menu bar. (Again, this must be `-1`, not `()`).
    
    ``` commonlisp
    (menu-bar-mode -1)
    ```
    
    I also disable the scroll bars.
    
    ``` commonlisp
    (scroll-bar-mode -1)
    ```

2.  Prompts for important things
    
    I rarely *actually* want to close Emacs, so it should always prompt
    if I accidentally ask to close.
    
    ``` commonlisp
    (setq confirm-kill-emacs 'yes-or-no-p)
    ```

3.  Information in the mode line
    
    The doom themes package comes with a function to make the mode line
    flash on error.
    
    ``` commonlisp
    (doom-themes-visual-bell-config)
    ```
    
    I'd previously just used `visible-bell`, but it's a bit nosier than
    necessary.
    
    ``` commonlisp
    ;;(setq visible-bell t)
    ```
    
    I also like the mode line to show the data and time.
    
    ``` commonlisp
    (setq display-time-day-and-date t)
    (setq display-time-24h-format t)
    (display-time)
    ```
    
    It's also useful to see the line number and column number.
    
    ``` commonlisp
    (line-number-mode t)
    (column-number-mode t)
    ```
    
    1.  Diminish minor mode names
        
        I use a lot of minor modes, so the mode list takes up a lot of
        space on the mode line.
        
        `diminish-mode` alleviates this by allowing us to hide modes or
        give them shorter names.
        
        ``` commonlisp
        (use-package diminish)
        ```
        
        I don't need to see that these modes are active.
        
        ``` commonlisp
        (eval-after-load "yas-minor-mode" '(diminish 'yas-minor-mode))
        (eval-after-load "yasnippet" '(diminish 'yas-minor-mode))
        (eval-after-load "undo-tree" '(diminish 'undo-tree-mode))
        (eval-after-load "which-key" '(diminish 'which-key-mode))
        (eval-after-load "org-indent" '(diminish 'org-indent-mode))
        ```
        
        If later I want to rename modes, just add a string argument to
        the above form with a (presumably shorter) name.

4.  Show line numbers on left
    
    As of Emacs 26, `display-line-numbers-mode` is the “proper” way to
    display line numbers next to a buffer.
    
    ``` commonlisp
    (global-display-line-numbers-mode)
    ```
    
    I find it concerning when the width of the column used for line
    numbers grows throughout the document; it makes me think Org mode
    headlines further down are nested. Setting
    `display-line-numbers-width-start` causes the system to count the
    number of lines when opening a buffer, and set the minimum width
    necessary to display all line numbers. It wastes some screen space,
    but is good for my sanity.
    
    ``` commonlisp
    (setq display-line-numbers-width-start t)
    ```
    
    Since line numbers can be distracting in some instances, see
    [1.4](#Key%20bindings) for toggles to turn it off.
    
    1.  <span class="todo TODO">TODO</span> Turn off line number mode
        for certain kinds of buffers
        
        Agda results, help, pdfs, dired, …
    
    2.  For older versions of Emacs
        
        In older versions, we can use `linum-mode`, but
        
          - it interacts poorly with `pdf-tools`, so we don't want to
            enable it globally, and
          - it makes Emacs quite laggy when working with larger files.
        
        So I generally just work without line numbers in older versions.
        
        ``` commonlisp
        ;;(add-hook 'text-mode-hook 'linum-mode)
        ;;(add-hook 'prog-mode-hook 'linum-mode)
        ```

5.  Highlight matching parenthesis when cursor is near
    
    ``` commonlisp
    (load-library "paren")
    (show-paren-mode 1)
    (transient-mark-mode t)
    (use-package paren)
    ```

6.  Show trailing whitespace and overlong lines
    
    It's good style not to have trailing whitespace.
    `show-trailing-whitespace` will colour any trailing whitespace.
    
    ``` commonlisp
    (global-whitespace-mode)
    (setq whitespace-style
          '(face
            trailing lines-tail empty
            tabs space-before-tab::tab space-after-tab::tab))
    ```
    
    This can be a little annoying, so there are toggles for various
    aspects under `Key bindings`.
    
    1.  <span class="todo TODO">TODO</span> Actually put those
        keybindings in place
        
        Add/remove from `whitespace-style` on the fly.

7.  Show ruler at 80 characters for (for `text` and `prog` mode)
    
    It's also good style to keep lines under 80 characters wide.
    `fill-column-indicator` will display a line (by default at 70
    characters)
    
    One thing worth noting is that with `org-indent-mode`, the line will
    be off by the length of the indentation (i.e. it will be at line 68
    if indented 2 characters, 66 if indented 4, etc.).
    
    The code to make it a global mode is from the [Emacs
    wiki](https://www.emacswiki.org/emacs/FillColumnIndicator).
    
    ``` commonlisp
    ;;(use-package fill-column-indicator)
    ;;(define-globalized-minor-mode global-fci-mode
    ;;  fci-mode (lambda () (fci-mode t)))
    ;;(global-fci-mode t)
    ```
    
    If I later need it enabled only for certain modes, this code could
    be of use.
    
    ``` commonlisp
    ;; (use-package fill-column-indicator)
    ;; (add-hook 'text-mode-hook 'fci-mode)
    ;; (add-hook 'prog-mode-hook 'fci-mode)
    ```
    
    After some use, I've found this indicator to be a combination of
    distracting and possibly causing some lag, so I no longer use it.
    `whitespace-mode` (set up above) makes a good alternative.

8.  Wrap lines
    
    Since I make an effort to keep my lines under 80 characters, I
    usually won't have lines too long for the window.
    
    If there are such lines, though, horizontally scrolling is annoying
    (or at least I find it so in Emacs).
    
    `visual-line-mode` will “wrap” lines which are too long.
    
    ``` commonlisp
    (global-visual-line-mode t)
    ```
    
    This can be annoying if working with a file with lots of long lines,
    so there is a shortcut under [1.4](#Key%20bindings) to toggle it.
    
    One annoying feature of `visual-line-mode`, at least in recent
    versions, is that it redefines a kill to only kill to the end of the
    visual line, rather than the whole line. This design decision can be
    reversed; thanks to the [Stack
    overflow](https://emacs.stackexchange.com/questions/13279/)
    contributor.
    
    ``` commonlisp
    (define-key visual-line-mode-map [remap kill-line] 'kill-line)
    ```
    
    Org mode also interferes with killing the whole line; it rebinds
    `C-k` to be `org-kill-line`, which seems to kill the visual line.
    Let's undo that rebinding.
    
    ``` commonlisp
    (add-hook 'org-mode-hook
      (lambda ()
        (define-key org-mode-map "\C-k" 'kill-line)))
    ```

### Automatically revert unchanged files which change on the disk

``` commonlisp
(global-auto-revert-mode t)
```

### <span class="todo TODO">TODO</span> Use `wordsmith` for English syntax highlighting

``` commonlisp
(use-package wordsmith-mode)
```

### Show possible completions as I type shortcuts

``` commonlisp
(use-package which-key)
(which-key-mode)
```

### Provide a visualisation of my undo tree

In Emacs, changes to a buffer are stored using a tree, rather than a
stack.

In most editors if we revert to an earlier state using “undo” and then
make some changes, we can no longer reach the state *before* the “undo”,
because it was popped of the stack and is now lost (the “redo” stack was
lost when we made changes).

This doesn't happen with an “undo tree”\!

I like to think of the undo tree as “extemely local” version control.

The package `undo-tree` provides a visualisation of the undo tree.

``` commonlisp
(use-package undo-tree)
(global-undo-tree-mode)
```

I like each node in the undo tree to have a timestamp; it helps identify
the node I want to return to.

``` commonlisp
(setq undo-tree-visualizer-timestamps t)
```

We can have a “diff” window display the changes made at each node in the
undo tree.

Unfortunately this seems to introduce a fair amount of lag on my system.

``` commonlisp
;;(setq undo-tree-visualizer-diff ())
```

### Session (opened buffers) setup and management

1.  Buffers to open at startup
    
    I like a bunch of files open (in the background) upon startup.
    
    ``` commonlisp
    (setq my-initial-background-files
      '("~/Dropbox/Organisation/setup/emacs/tips-and-tricks.org"
        "~/Dropbox/Organisation/setup/emacs/yankpad.org"
        "~/Dropbox/McMaster/Agda/agda-scratch.agda"
        "~/Dropbox/Organisation/log/phone-log.org"
    ))
    ```
    
    Along with this list, to facilite reseting the session (*clearing
    the desktop*), we must maintain a list of regular expressions
    matching the resulting buffer names, so that they can be skipped
    when deleting buffers on a (soft) reset.
    
    ``` commonlisp
    (setq my-initial-background-buffers-regexps
      '("tips-and-tricks.org"
        "yankpad.org"
        "agda-scratch.agda"
        "phone-log.org"
    ))
    ```
    
    Then there are files I want in focus (*on the desktop*) at startup.
    These are opened using my `my-desktop-initialise` (defined above),
    with the earlier files being to the right of and above the later
    files. The last file will be in focus.
    
    ``` commonlisp
    (setq my-initial-files
      '("~/Dropbox/Organisation/log/log.org"
        "~/Dropbox/Organisation/setup/emacs/emacs-init.org"
        "~/Dropbox/Organisation/org-scratch.org"
    ))
    ```
    
    As above, we need a list of regular expression matching the
    resulting buffer names.
    
    ``` commonlisp
    (setq my-initial-buffers-regexps
      '("log.org"
        "emacs-init.org"
        "org-scratch.org"
    ))
    ```

2.  Opening the initial buffers
    
    Note that this portion of the file should be *after* any settings
    that would affect these buffers. Otherwise those settings will not
    apply in these buffers.
    
    This portion of the file should only be run if the Emacs process is
    not headless. In the case that Emacs is (presumably) running as a
    daemon, as it does when initiating an asynchronous process such as
    an Org async export process.
    
    ``` commonlisp
    (if (display-graphic-p)
      (progn
       (loop for file in my-initial-background-files
         do (find-file file)
       )
       (cascading-find-files my-initial-files)
       (shrink-window 999) ;; basically minimize it vertically
      )
    )
    ```

3.  Seeing recently visited files
    
    Usually, I don't appreciate software opening in its previous state;
    if I closed an application (especially Emacs), there is probably a
    reason, and so I prefer a clean slate on startup.
    
    Unfortunately, at one point my work machine developed a nasty habit
    of turning off when put into sleep mode. There's was a reddit
    [thread](https://www.reddit.com/r/Crostini/comments/btwi1z/) and a
    Chromium issue
    [thread](https://bugs.chromium.org/p/chromium/issues/detail?id=968060)
    regarding the issue. It was actually fixed in an update almost
    immediately after I incorporated these changes, so I don't make wide
    use of the below setup.
    
    The process of reopening everything several times a day has become
    irritating, so I prefer to recover the previous session each time.
    
    `recentf-mode` is a minor mode which builds a list of recently
    opened files; see the [Emacs
    wiki](https://www.emacswiki.org/emacs/RecentFiles).
    
    ``` commonlisp
    (recentf-mode 1)
    ```
    
    By default, `recentf-mode` saves the list of recently opened on
    exit; however, in the case of a crash, this hook is never executed.
    Instead, we can set it up to be backed up regularly; say every 5
    minutes.
    
    ``` commonlisp
    (run-at-time nil (* 5 60) 'recentf-save-list)
    ```

4.  Buffers to preserve on session clear
    
    Emac's internal buffers are preserved on a session clear, but I
    additionally want to preserve the buffers I open on startup.
    
    ``` commonlisp
    (loop for buffer-re in my-initial-background-buffers-regexps
      do (add-to-list 'desktop-clear-preserve-buffers
                      buffer-re)
    )
    (loop for buffer-re in my-initial-buffers-regexps
      do (add-to-list 'desktop-clear-preserve-buffers
                      buffer-re)
    )
    ```

## Other

### Run my custom “dropbox start” command to ensure dropbox is running on the system

``` commonlisp
(start-process-shell-command "dropbox-start"
                             "*dropbox-start*"
                             "/opt/dropbox-filesystem-fix/dropbox_start.py")
```

## Temporary fixes

Herein I collect any workarounds I use to solve problems temporarily.

These should be truly temporary\!

### `org-strip-quotes`

In some versions of Org, `org-strip-quotes` was used in export
functions, but is not defined\! It should be in `lisp/org-macs.el`.

So I just define it here.

``` commonlisp
(defun org-strip-quotes (string)
  "Strip double quotes from around STRING, if applicable.
If STRING is nil, return nil."
  (org-unbracket-string "\"" "\"" string))
```

## Generating the README.md for my Emacs repo

This code generates a `README.md` file for my Emacs repo, including this
file and other relevant files.

# `yankpad.org`

## Description

### Introduction

This `org-mode` file contains commonly repeated snippets of text which I
expand using `yankpad` along with `yasnippets`.

Specifically, `yankpad` caches the snippets defined in this file, and
allows them to be expanded from a keyword with `yankpad-expand` or
selected from a keymap with `yankpad-map`.

With `yasnippets` installed (and its minor-mode active), the contents of
the snippets are actually executed using `yasnippets`, which provides a
great deal of functionality, including tab fields and arbitrary lisp
code execution.

### Organisation notes

The outermost headings of this file separate it into *categories*.
Snippets in a category named after a mode are available for yanking when
that mode is active. Other category's snippets can be made available by
switching to that category with `yankpad-set-category`. Snippets in
categories marked `:global:` are always available.

Inside categories, I use subheadings to organise snippets. The *lowest
level* headings define individual snippets.

Headings of snippets have the form `expandkeys: Name :settings:key:`,
where

  - `expandkeys` is a `:` separated list of keys for the snippet which
    can be expanded with `yankpad-expand`,
  - `Name` is the name of the snippet,
  - `settings` is `:` separated list of settings for the snippets,
    possibly including
      - `src`, which marks the snippet as being literate; only the
        contents of code blocks in such snippets are inserted.
      - `func`, which marks the snippet as a function. In this case no
        text is inserted; instead the code blocks of the snippet are
        executed.
      - `results`, which acts like `func`, but in this case, the
        *results* of the code blocks inside the snippet are inserted.

Most of my snippets are marked `:src:`, since this *is* a literate file
(and I don't tend to use snippets for executing code).

### Documentation links

  - [yankpad](https://github.com/Kungsgeten/yankpad)
  - [yasnippets](https://github.com/joaotavora/yasnippet)
  - [org-mode](https://orgmode.org/) (for good measure)

### Caveats

Sometimes snippets seem to act oddly in this file; specifically snippets
from lower in the file won't expand higher in the file (sometimes).

For that reason, the `org` mode snippets come first, as they are useful
for adding to this file.

## org-mode

I use `org` all the time, so you'll note in the `:properties:` drawer
that I include snippets from lots of other modes, since I often write
code from other modes in `org`.

I sometime use Org syntax outside of Org mode, so also see the
[2.3](#Default) category for more Org-related snippets.

### Other

1.  Gmail filters
    
    These XML snippets are for creating filters for my Gmail account,
    based on various criteria.
    
    1.  gmfto: Gmail filter by “to”
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="gmfto"><span class="smallcaps">gmfto</span></span>
        
        ``` xml
        <entry> <category term='filter'></category>
          <title>$1</title>
          <apps:property
              name='to'
              value='$1'/>
          <apps:property
              name='label'
              value='$2'/>
          ${3:<apps:property
              name='shouldMarkAsRead'
              value='true'/>}
          ${4:<apps:property
              name='shouldArchive'
              value='true'/>}
        </entry>
        ```
    
    2.  gmffrom: Gmail filter by “from”
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="gmffrom"><span class="smallcaps">gmffrom</span></span>
        
        ``` xml
        <entry> <category term='filter'></category>
          <title>$1</title>
          <apps:property
              name='from'
              value='$1'/>
          <apps:property
              name='label'
              value='$2'/>
          ${3:<apps:property
              name='shouldMarkAsRead'
              value='true'/>}
          ${4:<apps:property
              name='shouldArchive'
              value='true'/>}
        </entry>
        ```

## Default <span class="tag" data-tag-name="global"><span class="smallcaps">global</span></span>

The category “Default” will be used if there is no category for the
current major mode.

I make these snippets available everywhere else as well by marking the
category as `:global:`.

### Org related

I often use Org syntax outside of Org mode, especially when writing
literate Agda documents. So many Org syntax snippets are included here
to be available everywhere.

1.  dh: Document header
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgdh"><span class="smallcaps">orgdh</span></span>
    
    I usually use what I think is a fairly minimalist document header.
    
    ``` text
    #+Title: $1
    #+Author: ${2:Mark Armstrong}
    #+Description: $3
    
    $0
    ```

2.  `org` blocks

3.  `src` blocks
    
    Note that the `,#` expands to the `org` “comment” character `#`.
    
    This is needed to have a `#+end_src` *inside* a `src` block.
    
    1.  src: Generic source block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgsrc"><span class="smallcaps">orgsrc</span></span>
        
        ``` text
        #+begin_src $1
        $0
        #+end_src
        ```
    
    2.  el: Emacs lisp block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgel"><span class="smallcaps">orgel</span></span>
        
        ``` text
        #+begin_src emacs-lisp
        $0
        #+end_src
        ```
    
    3.  t: Plaintext
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgt"><span class="smallcaps">orgt</span></span>
        
        ``` text
        #+begin_src text
        $0
        #+end_src
        ```
    
    4.  latex: LaTeX
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orglatex"><span class="smallcaps">orglatex</span></span>
        
        ``` text
        #+begin_src latex
        $0
        #+end_src
        ```
    
    5.  sh: Shell
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgsh"><span class="smallcaps">orgsh</span></span>
        
        ``` text
        #+begin_src shell
        $0
        #+end_src
        ```
    
    6.  ag: Agda code block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgag"><span class="smallcaps">orgag</span></span>
        
        ``` text
        #+begin_src org-agda
        $0
        #+end_src
        ```
    
    7.  oz: Oz code block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgoz"><span class="smallcaps">orgoz</span></span>
        
        ``` text
        #+begin_src oz :results output :noweb yes
        $0
        #+end_src
        ```
    
    8.  rb: Ruby code block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgrb"><span class="smallcaps">orgrb</span></span>
        
        ``` text
        #+begin_src ruby
        $0
        #+end_src
        ```
    
    9.  py: Python code block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgpy"><span class="smallcaps">orgpy</span></span>
        
        ``` text
        #+begin_src python
        $0
        #+end_src
        ```
    
    10. ic: “Interactive” C block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgicc"><span class="smallcaps">orgicc</span></span>
        
        ``` text
        #+begin_src c :tangle (currently-working-with "${1:generated}")
        $0
        #+end_src
        ```
    
    11. icn: Inactive “Interactive” C block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgicn"><span class="smallcaps">orgicn</span></span>
        
        ``` text
        #+begin_src c :tangle (not-currently-working-with "${1:generated}")
        $0
        #+end_src
        ```
    
    12. ich: “Interactive” C header block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgich"><span class="smallcaps">orgich</span></span>
        
        ``` text
        #+begin_src c :tangle (currently-working-with-header "${1:generated}")
        $0
        #+end_src
        ```
    
    13. xml: XML block
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgxml"><span class="smallcaps">orgxml</span></span>
        
        ``` text
        #+begin_src xml
        $0
        #+end_src
        ```

4.  Blocks for LaTeX exports
    
    1.  ldisc: Discussion
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="ldisc"><span class="smallcaps">ldisc</span></span>
        
        ``` commonlisp
        #+attr_LaTeX: :options [$1]
        #+begin_discussion
        $0
        #+end_discussion
        ```

5.  Others
    
    1.  c: Center
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgcntr"><span class="smallcaps">orgcntr</span></span>
        
        ``` commonlisp
        #+begin_center
        $0
        #+end_center
        ```
    
    2.  e: Example
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgex"><span class="smallcaps">orgex</span></span>
        
        ``` commonlisp
        #+begin_example $1
        $0
        #+end_example
        ```
    
    3.  quot: Quote
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgquot"><span class="smallcaps">orgquot</span></span>
        
        ``` commonlisp
        #+begin_quote
        $0
        #+end_quote
        ```
    
    4.  ques: Question
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="orgques"><span class="smallcaps">orgques</span></span>
        
        ``` commonlisp
        #+begin_example $1
        $0
        #+end_example
        ```
    
    5.  ans: Answer
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="organs"><span class="smallcaps">organs</span></span>
        
        ``` commonlisp
        #+begin_example $1
        $0
        #+end_example
        ```

### Punctuation, parentheses, etc.

1.  dq: Double quotes
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="dq"><span class="smallcaps">dq</span></span>
    
    ``` text
    “$1” $0
    ```

2.  card: Cardinality
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="card"><span class="smallcaps">card</span></span>
    
    ``` text
    |$1| $0
    ```

3.  enc: Encoding
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="enc"><span class="smallcaps">enc</span></span>
    
    ``` commonlisp
    ⌜$1⌝ $0
    ```

4.  denc: Decoding
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="denc"><span class="smallcaps">denc</span></span>
    
    ``` commonlisp
    ⟦$1⟧ $0
    ```

### Words

1.  det: deterministic
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span>
    
    ``` text
    deterministic
    ```

2.  ndet: non-deterministic
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span>
    
    ``` text
    non-deterministic
    ```

### Filepaths

1.  Thesis
    
    1.  simp-dfa-tex:
        <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span>
        
        ``` text
        latex/Automata/Simple/DFA.tex
        ```

### Other global

1.  thisfile: Name of the current file (buffer)
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="thisfile"><span class="smallcaps">thisfile</span></span>
    
    ``` text
    `(buffer-name)`
    ```

2.  dasht: A “title” surrouned by dashes
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="dasht"><span class="smallcaps">dasht</span></span>
    
    ``` text
    ${1:$(make-string (string-width yas-text) ?\-)}
    ${1:Title}
    ${1:$(make-string (string-width yas-text) ?\-)}
    $0
    ```
    
    Credit: the
    \[\[<http://joaotavora.github.io/yasnippet/snippet-development.html#orge2c1f71>\]\[yasnippet
    tutorial

3.  dj: Get a dad joke
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="dj"><span class="smallcaps">dj</span></span>
    
    ``` text
    `(dad-joke)`
    ```

4.  yas: Yasnippet template
    <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="yas"><span class="smallcaps">yas</span></span>
    
    This should really move to a specialised category.
    
    ``` text
    # name: $1
    # key: $2
    # --
    $0
    ```

## agda2-mode

### ag: Literate code block <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="ag"><span class="smallcaps">ag</span></span>

``` text
\begin{code}
$0
\end{code}
```

### ga: Break up a literate code block <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="ga"><span class="smallcaps">ga</span></span>

Often we need to break up code blocks somewhere in the middle.

The `\end{code}` here is an Elisp string so that it's not mistaken as
ending a LaTeX code environment in *this* document.

``` text
`"\\end{code}"`
$0
\begin{code}
```

### tag: Catch-file-between-tags <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="tag"><span class="smallcaps">tag</span></span>

``` text
%<*$1>
$0
%</$1>
```

### fun: Function declaration with type signature <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="fun"><span class="smallcaps">fun</span></span>

``` text
$1 : $0
$1 = ?
```

### dt: Datatype declaration <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="dt"><span class="smallcaps">dt</span></span>

``` text
data $1 : Set where
  $2 : $1
```

### setl: `Set` arguments parameterised by a `Level` <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="setl"><span class="smallcaps">setl</span></span>

``` text
{${1:a} : Level} → (${2:A} : Set $1) → $0
```

### isetl: *Implicit* `Set` arguments parameterised by a `Level` <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="isetl"><span class="smallcaps">isetl</span></span>

``` text
{${1:a} : Level} → {${2:A} : Set $1} → $0
```

### 2setl: `Set` arguments parameterised by two `Level's` <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="2setl"><span class="smallcaps">2setl</span></span>

``` text
{${1:a} ${2:b} : Level} → (${3:A} : Set $1) → (${4:B} : Set $1) → $0
```

### i2setl: *Implicit* `Set` arguments parameterised by two `Level's` <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="i2setl"><span class="smallcaps">i2setl</span></span>

``` text
{${1:a} ${2:b} : Level} → {${3:A} : Set $1} → {${4:B} : Set $1} → $0
```

### with: `with` pattern <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="with"><span class="smallcaps">with</span></span>

``` text
with $1
... | ${2:thing} = $0
```

### eqr: Start a `≡-Reasoning` block <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="eqr"><span class="smallcaps">eqr</span></span>

``` text
begin
  ?$0
≡⟨ ${1:?} ⟩
  ?
∎
```

### eqs: Insert a step in a `≡-Reasoning` block <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="eqs"><span class="smallcaps">eqs</span></span>

``` text
≡⟨ ${1:?} ⟩
  $0
```

## tex-mode

### leg: General LaTeX environment <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="leg"><span class="smallcaps">leg</span></span>

``` text
\begin{$1}
$0
\end{$1}
```

### lei: LaTeX itemize <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="lei"><span class="smallcaps">lei</span></span>

``` text
\begin{itemize}
$0
\end{itemize}
```

### lec: LaTeX center <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="lec"><span class="smallcaps">lec</span></span>

``` text
\begin{center}
$0
\end{center}
```

### li: LaTeX item <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="li"><span class="smallcaps">li</span></span>

``` text
\item $0
```

### cfbt: Import a tagged portion of another file <span class="tag" data-tag-name="src"><span class="smallcaps">src</span></span> <span class="tag" data-tag-name="li"><span class="smallcaps">li</span></span>

Using the package `catchfilebetweentags`.

``` text
\ExecuteMetaData[$1]{$2}$0
```
